---
title: "gBlock maker"
author: "Hayley Zorkic"
date: "11/17/2020"
output: html_document
---

#I'll provide a reference sequence for a section of the spike protein (Part1a, Part1b, or Part2)
You'll be given a set of mutations that we want to integrate into the reference sequence.  For example: L455D will fall in Part2
Use a mammalian codon optimized sequence for the mutant codon we want to integrate.
Run a filter to make sure that there are no AarI or BsmBI cut sites added to the new oligo.
Then add the appropriate 5' and 3' flanking sequences.  These are different for each part so don't mix them up.
Final output should be a spreadsheet with the first column being the mutation name "L455D" and the second column should be the eBlock sequence with the mutation in it.
```{r}
library(stringr)
library(seqinr)
library(xlsx)
library(tidyverse)
```

```{R}
#enter filepath here
mutations <- read.xlsx("03152021.xlsx", sheetIndex = 1, header = FALSE)
print(mutations)
```

```{r include=false}
#enter infromation about part 1 here. Copy and paste this section if there are more than 1 parts and change the 1 with 2,3,4,... respectively. 
part1astart <- 1
part1aend <- 135
part1arefseq <- "atgttcgtgttcctggtgctcctgcctctggtgagcagccagtgcgtgaacctgaccacccgaacccagctcccaccagcctacaccaacagctttacacggggcgtgtactaccctgacaaggtgttcagatctagcgtcctgcacagcactcaggacctcttcctgccgttcttcagcaacgtgacatggttccacgccatccacgtgagcggcacaaacggaaccaagcggtttgataaccccgtcctgccattcaatgatggagtttacttcgccagtaccgagaagagtaacatcatccggggctggatcttcggcaccaccctggatagcaaaacacagagcctcctgatcgtgaacaatgccacgaacgtcgtgatcaaggtgtgcgagttccagtttt"
part1aprime5 <- "gcatcgtctcatcggcacctgccacctgac"
part1aprime3 <- "gcaaggtggcaggtggacctgagacggcat"


#part 1b
part1bstart <- 138
part1bend <- 265
part1brefseq <- "tgatcctttcctgggtgtgtactaccacaagaacaacaagagctggatggaaagcgagttcagagtctacagcagcgccaacaactgcacattcgagtacgtctctcagccttttctgatggaccttgaggggaaacaaggcaacttcaagaacctgagagaattcgtgttcaagaacatcgacggctacttcaaaatctactccaagcacacacccatcaacctggtccgggacctccctcagggcttcagcgccctggaacccctggtcgacctgcccataggcatcaacataacgcggttccaaaccctgctggccctgcatagatcctacctgactcctggcgacagcagcagcggatggaccgccggagctgcagcctacta"
part1bprime5 <- "gcatcgtctcatcggcacctgccaccgcaa"
part1bprime3 <- "tgtgggtggcaggtggacctgagacggcat"
  
#Part 1
part1start <- 136
part1end <- 137
part1refseq <- "ggtggcaggtggaaagtgaaacgtgatttcatgcgtcattttgaacattttgtaaatcttatttaataatgtgtgcggcaattcacatttaatttatgaatgttttcttaacatcgcggcaactcaagaaacggcaggttcggatcttagctactagagaaagaggagaaatactagatgcgtaaaggcgaagagctgttcactggtgtcgtccctattctggtggaactggatggtgatgtcaacggtcataagttttccgtgcgtggcgagggtgaaggtgacgcaactaatggtaaactgacgctgaagttcatctgtactactggtaaactgccggttccttggccgactctggtaacgacgctgacttatggtgttcagtgctttgctcgttatccggaccatatgaagcagcatgacttcttcaagtccgccatgccggaaggctatgtgcaggaacgcacgatttcctttaaggatgacggcacgtacaaaacgcgtgcggaagtgaaatttgaaggcgataccctggtaaaccgcattgagctgaaaggcattgactttaaagaggacggcaatatcctgggccataagctggaatacaattttaacagccacaatgtttacatcaccgccgataaacaaaaaaatggcattaaagcgaattttaaaattcgccacaacgtggaggatggcagcgtgcagctggctgatcactaccagcaaaacactccaatcggtgatggtcctgttctgctgccagacaatcactatctgagcacgcaaagcgttctgtctaaagatccgaacgagaaacgcgatcatatggttctgctggagttcgtaaccgcagcgggcatcacgcatggtatggatgaactgtacaaatgaccaggcatcaaataaaacgaaaggctcagtcgaaagactgggcctttcgttttatctgttgtttgtcggtgaacgctctctactagagtcacactggctcaccttcgggtgggcctttctgcgtttatacacctgccacc"
part1prime5 <- "gcatcgtctcatcggcacctgccacctgac"
part1prime3 <- "tgtgggtggcaggtggacctgagacggcat"
  
#Part 2
part2start <- 268
part2end <- 521
part2refseq <- "ggctacctgcaacctagaaccttcctgctgaagtacaacgagaacggcacaatcacagacgccgtcgactgcgccctggaccctctctctgagacaaagtgcaccctgaagtccttcaccgtggaaaagggcatctaccagaccagcaacttccgggtgcagcctacagagagcatcgtgcgatttccaaacattaccaacctctgccccttcggcgaggtgtttaacgccacaagatttgcctccgtttacgcctggaatagaaagagaatcagcaattgtgtggccgactactccgtgctgtataacagcgcctctttcagcaccttcaagtgctacggcgtttccccaacaaagctgaatgacctgtgcttcaccaacgtgtacgccgactccttcgtaattagaggcgatgaggtgcggcagatcgcaccaggccagaccggtaagatcgctgactacaactataagctgcctgatgattttacaggctgcgtgatcgcctggaactctaacaacctggatagcaaggtgggcggcaactacaactacctgtaccggctgtttcgcaagtctaacctgaaacctttcgagagagacatctccacagagatctaccaggccggttctacaccttgtaacggggtggaaggcttcaactgttacttccctctgcaaagctacggcttccagcctaccaatggagtcggctaccagccataccgggtggtcgtgctgtccttcgagttactccacgccccc"
part2prime5 <- "gcatcgtctcatcggcacctgccacctgtg"
part2prime3 <- "gccaggtggcaggtggacctgagacggcat"

#Part 3
part3start <- 524
part3end <- 786
part3refseq <- "ccgtctgcggtcctaagaagtccaccaatctggttaagaacaaatgcgtgaacttcaacttcaacggcctgaccgggaccggcgtgctgaccgaaagcaacaaaaagttcctccccttccagcagttcggccgtgatatcgctgacaccacagatgccgtcagagatccacagaccctggaaatcctggatattacaccctgctccttcggaggagtttctgtgatcacccccgggaccaataccagcaaccaggtggctgtgctgtaccaaggtgttaactgcaccgaggttcctgtggccatccacgccgatcagctgacacctacttggagagtgtactccactggctccaatgtgttccagaccagggccggatgtctgatcggcgccgagcacgtgaataacagttacgagtgcgacatccctatcggcgccggcatctgtgccagctaccagacccagacaaacagccctgggtctgcttcctctgtagctagccagagcatcatcgcctacaccatgagcctgggcgcagagaacagcgtggcctattccaacaactctatcgccattcccaccaactttacaattagcgtcacaacagagatcctgcccgtgagcatgaccaagaccagcgtggactgtacaatgtacatctgtggcgacagcactgaatgcagcaacctgctgctgcaatacggctccttttgcacccaactgaaccgggcgctgaccggaatcgccgtggaacaggacaaaaatacccaggaggtgttcgcccaagtgaagca"
part3prime5 <- "gcatcgtctcatcggcacctgccaccgcca"
part3prime3 <- "gatcggtggcaggtggacctgagacggcat"

#Part 4
part4start <- 789
part4end <- 1053
part4refseq <- "tacaagaccccacctatcaaggacttcggcggctttaactttagccagattctccctgatccttctaagcctagcaagcggagccctatcgaggatctgctgttcaacaaggtcaccctggccgatgccggctttatcaaacagtatggcgattgcctgggcgacatagccgccagagatctgatctgcgcccagaaattcaacggcctgacagttctcccacctctgctgaccgacgagatgatcgctcagtacacctctgccctgctggctggcaccatcacatctgggtggacatttggcgccggccccgccctgcagatcccctttcccatgcagatggcctatagattcaacggaatcggcgtgacccagaacgtgctgtatgaaaaccagaagctgatcgctaaccagttcaattctgccatcggcaagatccaggactccctctcctctacccccagcgccctgggcaaactgcaggacgtggtgaatcagaacgcccaagccctgaacaccctggtgaagcagctcagcagcaattttggcgccatcagctctgtgctgaacgatatcctgtctagactggaccctccagaagccgaagtccagatcgatagactgatcacaggcagactgcagtccctgcaaacctacgtgacccaacagctgatcagggccgctgaaataagagccagcgccaatctcgccgctaccaagatgtccgagtgtgtgctgggacagtctaaacgcgttgacttctgcggcaaaggctatcacctgatgagcttcccc"
part4prime5 <- "gcatcgtctcatcggcacctgccaccgatc"
part4prime3 <- "cagaggtggcaggtggacctgagacggcat"

#Part 5
part5start <- 1056
part5end <- 1206
part5refseq <- "gcgcgccgcacggcgtggtgttcctgcatgtgacatacgtgcctgcccaagagaagaatttcacaaccgcccctgccatctgccacgacggcaaggcccacttcccaagagagggcgttttcgtttccaatggcacacactggttcgtgacacaaagaaacttctacgaaccccagattatcaccaccgacaacaccttcgtgagtggcaattgtgacgtggtcatcggaatcgtgaacaacacagtgtacgaccctctgcaacctgagctggactcttttaaggaagagctggacaagtactttaaaaaccacaccagccccgatgtggacctgggcgacatcagtggcattaacgccagcgtggtgaacatccaaaaggaaatcgacagactgaacgaggtggccaagaacctgaacgagtccctgatcgacctgcaggagctcggcaaatacga"
part5prime5 <- "gcatcgtctcatcggcacctgccacccaga"
part5prime3 <- "gcagggtggcaggtggacctgagacggcat"
  
```

#mammalian optimized codons
```{R}
optimizeCodon <- function(AA){
  if (AA == "A"){
    codon <- "gcc"
  }
  if (AA == "R"){
    codon <- "cgg"
  }
  if (AA == "N"){
    codon <- "aac"
  }
  if (AA == "D"){
    codon <- "gac"
  }
  if (AA == "C"){
    codon <- "tgc"
  }
  if (AA == "E"){
    codon <- "gag"
  }
  if (AA == "Q"){
    codon <- "cag"
  }
  if (AA == "G"){
    codon <- "ggc"
  }
  if (AA == "H"){
    codon <- "cac"
  }
  if (AA == "I"){
    codon <- "atc"
  }
  if (AA == "L"){
    codon <- "ctg"
  }
  if (AA == "K"){
    codon <- "aag"
  }
  if (AA == "M"){
    codon <- "atg"
  }
  if (AA == "F"){
    codon <- "ttc"
  }
  if (AA == "P"){
    codon <- "ccc"
  }
  if (AA == "S"){
    codon <- "tcc"
  }
  if (AA == "T"){
    codon <- "acc"
  }
  if (AA == "W"){
    codon <- "tgg"
  }
  if (AA == "Y"){
    codon <- "tac"
  }
  if (AA == "V"){
    codon <- "gtg"
  }
  return(codon)
}
```

#is there an alanine at the position already?
```{R}
alanine <- function(refseq, positionNT){
  if (
    substr(refseq, start=positionNT, stop=(positionNT+2)) == "gct" |
    substr(refseq, start=positionNT, stop=(positionNT+2)) =="gcc" | 
    substr(refseq, start=positionNT, stop=(positionNT+2)) =="gca" | 
    substr(refseq, start=positionNT, stop=(positionNT+2)) =="gcg"){
    return(TRUE)
  }
  else{
    return(FALSE)
  }
}
```



#convert DNA to AA, add mutation
```{r}
mutate <- function(df){
  colnames(df) <- c("AA","Position","Mutation")
  df[,2] <- sapply(df[,2], as.numeric)


print(df)
    #for each row in the data.frame
    for (i in 1:length(df[[1]])){
    #column 2 gives us AA Position

    j <- 2

    positionAA <- df[i,j]
    
    #column 3 gives us mutation.
    j <- j + 1
    mutation <- df[i,j]
  
if (part1astart <= positionAA & positionAA <= part1aend){
    #if part is in 1a
    # this starts at nt 1
    refseq <- part1arefseq
    positionNT <- 3*(positionAA)-2
    prime5 <- part1aprime5 
    prime3 <- part1aprime3
} 
else if (part1bstart <= positionAA & positionAA <= part1bend){
    #if part is in 1b
    #this starts at 410nt
    refseq <- part1brefseq
    positionNT <- (3*(positionAA)-2)-410
    prime5 <- part1bprime5 
    prime3 <- part1bprime3 
} 
else if (part1start <= positionAA & positionAA <= part1end) {
    #if part is in 1
    # this starts at position 0
    refseq <- part1refseq
    positionNT <- 3*(positionAA)-2
    prime5 <- part1prime5
    prime3 <- part1prime3
}
else if (part2start <= positionAA & positionAA <= part2end){
    #if part is in 2 
    #this starts at 801
    refseq <- part2refseq
    positionNT <- (3*(positionAA)-2)-801
    prime5 <- part2prime5
    prime3 <- part2prime3
} 

else if (part3start <= positionAA & positionAA <= part3end){
    #if part is in 3
    #this starts at 1567
    refseq <- part3refseq
    positionNT <- (3*(positionAA)-2)-1567
    prime5 <- part3prime5
    prime3 <- part3prime3
} 

else if (part4start <= positionAA & positionAA <= part4end){
    #if part is in 4 
    #this starts at 2364
    refseq <- part4refseq
    positionNT <- (3*(positionAA)-2)-2364
    prime5 <- part4prime5
    prime3 <- part4prime3
} 

else if (part5start <= positionAA & positionAA <= part5end){
    #if part is in 5 
    #this starts at 3163
    refseq <- part5refseq
    positionNT <- (3*(positionAA)-2)-3163
    prime5 <- part5prime5
    prime3 <- part5prime3
} 
else {
    refseq <- "=============================================This mutation lies on an overhang sequence ============================================="
    positionNT <- 1
    prime5 <- "======="
    prime3 <- "======="}

### FOR ALANINE LIBRAIES: if we are doing alanine libraries, this chunk will label the sequence with a OOO that will be marked and deleted later. 
if(df[i,3] == "A" && alanine(refseq, positionNT) == TRUE){
    refseq1 <- "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
    error <- "You are trying to mutate an position that is already an Alanine into an Alanine"
}

else if(df[i,3] == "-"){
    refseq1 <- paste0(substr(refseq,1,(positionNT-1)), substr(refseq,(positionNT+3),nchar(refseq)))
    error <- "This is a - site"
}

else{
  mutation <- optimizeCodon(df[i,j])
  refseq1 <- paste0(substr(refseq,1,(positionNT-1)), mutation, substr(refseq,(positionNT+3),nchar(refseq)))
  error <- "none"
}

### check for BsmB1 and Aar1 cut Sites
if (grepl("cacctgc|cgtccac", refseq1) == TRUE){
    #if there is, notify the user
    df[i,5] <- "There is a BsmBI or AarI site in this sequence"
    df[i,4] <- paste0(prime5 , refseq1 , prime3)}
  
else{
    df[i,4] <- paste0(prime5 , refseq1 , prime3)
    #if there is not, just add primers
    df[i,5] <- paste0(error, " There are ", nchar(refseq1), " nt in this sequence ")} #QC step to give the number of nt in the sequence 
    
    }
  colnames(df)[4] <- "eblock sequence"
  colnames(df)[5] <- "notes"
  return(df)
}

```

```{r}
mutated <- mutate(mutations)
mutated$mutation <- paste0(mutated$AA, mutated$Position, mutated$Mutation)
mutated <- mutated %>% select(6, 4, 5)

write.xlsx(mutated, file = "OhMy.xlsx", row.names = FALSE)
```

